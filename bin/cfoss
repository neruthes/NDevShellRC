#!/bin/bash

OSS_DIRPATH="/mnt/cf-r2/oss"
if [[ ! -e $OSS_DIRPATH/ismounted ]]; then
    echo "[ERROR] OSS directory is not mounted."
    exit 1
fi

if [[ " $2 " == *"t"* ]]; then
    isTMP=y
fi
OSS_DOMAIN="oss-r2.neruthes.xyz"





INPUT_PATH="$1"
INPUT_FULL_PATH="$(realpath "$INPUT_PATH")"
INPUT_FN="$(basename "$INPUT_FULL_PATH")"
INPUT_DIRNAME="$(basename $(dirname "$INPUT_FULL_PATH"))"

EXTNAME="${INPUT_FN/*./}"

if [[ -z "$OSS_SUBDIR" ]]; then
    OUTPUT_SUBDIR="keep/$INPUT_DIRNAME/"
else
    OUTPUT_SUBDIR="keep/$OSS_SUBDIR/"
fi

SEED_1="1d69b27764ff473f8c9221a3d32bda66"
if [[ $isTMP == y ]]; then
    DATEMARK="$(date -r "$INPUT_FULL_PATH" +%Y-%m-%d)"
    SEED_2="$DATEMARK"
    OUTPUT_FN_PREFIX="$DATEMARK--"
    OUTPUT_SUBDIR=tmp/
fi
PREHASH="$SEED_1:$SEED_2:$HOSTNAME:$USER:$INPUT_FULL_PATH"
REALHASH="$(sha256sum <<< "$PREHASH" | cut -c1-32)"

OUTPUT_FN="${OUTPUT_FN_PREFIX}${INPUT_FN}--${REALHASH}.${EXTNAME}"


FIANL_FS_PATH="${OSS_DIRPATH}/${OUTPUT_SUBDIR}${OUTPUT_FN}"
FINAL_HTTP_PATH="https://${OSS_DOMAIN}/${OUTPUT_SUBDIR}${OUTPUT_FN}"

echo "FIANL_FS_PATH=$FIANL_FS_PATH"
echo "FINAL_HTTP_PATH=$FINAL_HTTP_PATH"

mkdir -p "$(dirname "$FIANL_FS_PATH")"
cp "$INPUT_FULL_PATH" "$FIANL_FS_PATH" &
