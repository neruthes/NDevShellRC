#!/bin/bash

OSS_DOMAIN="oss-r2.neruthes.xyz"

touch $HOME/.config/cfoss.conf
source $HOME/.config/cfoss.conf

#######################################################################################
### What to expect from config:
# S3_ENDPOINT=https://xxxxxxxxxxxxxxxx.r2.cloudflarestorage.com
#######################################################################################


OSS_DOMAIN="oss-r2.neruthes.xyz"

if [[ -e "$2" ]]; then
    for i in $@; do
        cfoss $i
    done
    exit 0
fi







INPUT_PATH="$1"
INPUT_FULL_PATH="$(realpath "$INPUT_PATH")"
INPUT_FN="$(basename "$INPUT_FULL_PATH")"
INPUT_DIRNAME="$(basename $(dirname "$INPUT_FULL_PATH"))"

EXTNAME="${INPUT_FN/*./}"

if [[ -z "$OSS_SUBDIR" ]]; then
    OUTPUT_SUBDIR="keep/$INPUT_DIRNAME/"
    OUTPUT_SUBDIR="o/"
else
    OUTPUT_SUBDIR="keep/$OSS_SUBDIR/"
fi

SEED_1="1d69b27764ff473f8c9221a3d32bda66"
if [[ $TMP == y ]]; then
    DATEMARK="$(date -r "$INPUT_FULL_PATH" +%Y-%m-%d)"
    SEED_2="$DATEMARK"
    OUTPUT_FN_PREFIX="$DATEMARK--"
    OUTPUT_SUBDIR=tmp/
fi
PREHASH="$SEED_1:$SEED_2:$USER:$INPUT_FULL_PATH"
REALHASH="$(sha256sum <<< "$PREHASH" | cut -c1-32)"

OUTPUT_FN="${OUTPUT_FN_PREFIX}${INPUT_FN}--${REALHASH}.${EXTNAME}"


FIANL_OBJ_KEY="${OUTPUT_SUBDIR}${OUTPUT_FN}"
FINAL_HTTP_URL="https://${OSS_DOMAIN}/${OUTPUT_SUBDIR}${OUTPUT_FN}"

echo "FIANL_OBJ_KEY=$FIANL_OBJ_KEY"
echo "FINAL_HTTP_URL=$FINAL_HTTP_URL"




S3_ARGS="--endpoint-url $S3_ENDPOINT --bucket oss"
aws s3api put-object  --body "$INPUT_FULL_PATH"  --key "$FIANL_OBJ_KEY"  $S3_ARGS  >/dev/null

