#!/bin/bash

srcdir="$1"
destdir="$2"

if [[ -z $2 ]]; then
    echo "Usage:  $0  srcdir  destdir"
    echo "  Move files from srcdir to destdir"
    exit 1
fi

safe_seed="$(cat /dev/stdin /etc/fstab <<< "$USER:$HOSTNAME:$PATH:$MANPATH" | sha256sum | cut -c1-30)"

while true; do
    IFS=$'\n'
    for fn in $(find "$srcdir" -type f); do
        rn="$(realpath $fn)"
        rn_hash="$(sha256sum <<< "$safe_seed:$rn" | cut -c1-48 | xxd -r -p - | base64 | tr '+/=' '0')"
        dest_path="$destdir/$(date +%F | tr -d '-').$rn_hash.$(basename "$rn")"
        mv -vf "$rn" "$dest_path"
        chmod 664 "$dest_path"
    done
    sleep 5
done
