#!/bin/bash



### Parse argv
if [[ " $@ " == *' -e '* ]] || [[ " $@ " == *' --empty '* ]]; then
    f_EMPTY=y
fi
if [[ " $@ " == *' -d '* ]] || [[ " $@ " == *' --dry-run '* ]]; then
    f_NOSYNC=y
fi
if [[ " $@ " == *' -t '* ]] || [[ " $@ " == *' --tmp '* ]]; then
    f_TMP=y
fi
if [[ " $@ " == *' -a '* ]] || [[ " $@ " == *' --all '* ]]; then
    f_SENDALL=y
fi




INDIRPATH="$PWD"
if [[ -e "$1" ]]; then
    INDIRPATH="$(realpath "$1")"
fi

FINAL_HASH="$(echo "$USER:$HOSTNAME:$INDIRPATH" | sha256sum | cut -c1-24)"

if [[ $f_TMP == y ]]; then
    DIRNAME_PREFIX="TMP-"
fi
RDIRNAME="$DIRNAME_PREFIX$(basename "$INDIRPATH")-$FINAL_HASH"


RSYNC_ARGS="-avxW --delete --mkpath --safe-links"
if [[ -z "$RSYNC_INCLUDE_LIST" ]]; then
    RSYNC_INCLUDE_LIST="+ /*
- /.git"
fi
if [[ -e ".rsync_include.list" ]]; then
    RSYNC_INCLUDE_LIST="$(cat .rsync_include_list)"
fi
if [[ $f_SENDALL == y ]]; then
    RSYNC_INCLUDE_LIST=""
fi

RSYNC_DEST="NDLT6G:/mnt/NEPd3_Caster/LS/NAS_public/$RDIRNAME/"

if [[ $f_NOSYNC != y ]]; then # Should run rsync
    if [[ $f_EMPTY == y ]]; then # 
        EMPTYDIR="/tmp/emptydir.$USER.$RANDOM$RANDOM$RANDOM$RANDOM"
        mkdir -p "$EMPTYDIR"
        rsync $RSYNC_ARGS \
            "$EMPTYDIR/" \
            "$RSYNC_DEST"
        rm -rf "$EMPTYDIR"
    fi
    rsync $RSYNC_ARGS "$INDIRPATH/" "$RSYNC_DEST" --exclude '.*' \
        --include-from=- <<< "$RSYNC_INCLUDE_LIST"
fi


echo "https://nas-public.neruthes.xyz:2096/$RDIRNAME/"
