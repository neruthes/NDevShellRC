#!/bin/bash

mkdir ~/.tmp > /dev/null 2>&1
echo "Publishing WAN DDNS..."

CURL_LOG="$HOME/.tmp/NDevSync-wanddns--43a78eb1af006c5afae3b4181c2b9550.txt"

# curl -4 http://ifconfig.co/ > /tmp/cached_wanip
MY_WAN_IP_ADDR=$(cat /tmp/cached_wanip)

curl --show-error -s -X PUT "https://api.cloudflare.com/client/v4/zones/cef23400ccfef7aa9511988f2e27b181/dns_records/43a78eb1af006c5afae3b4181c2b9550" \
    -H "Authorization: Bearer $(pasm p token.cloudflare.OmniDnsToken)" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"A\",\"name\":\"homeddns\",\"content\":\"$MY_WAN_IP_ADDR\",\"ttl\":120,\"proxied\":false}" > $CURL_LOG

if [[ ! -z "$(grep 'success":true' "$CURL_LOG")" ]]; then
    echo "[INFO] Updated succesfully"
else
    echo "[ERROR] Something happened."
    cat "$CURL_LOG"
fi
