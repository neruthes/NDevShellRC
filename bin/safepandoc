#!/bin/bash

# safepandoc (version 0.2.0)
# A wrapper to treat input as plain text by finding a transparent intermediate format.

DEST_FORMAT="$1"
INPUT_FILE="$2"

# 1. Usage & Help
if [[ -z "$DEST_FORMAT" ]]; then
    cat <<EOF >&2
safepandoc (version 0.2.0)
Usage:
    safepandoc {dest_format} [input_file]
    echo "text" | safepandoc {dest_format}

This script finds a Pandoc input format that treats your text as raw content
by comparing stripped versions of the input and the output.
EOF
    exit 0
fi

# 2. Setup Temporary Files
TMP_DIR=$(mktemp -d)
# Ensure cleanup on exit (normal or error)
trap 'rm -rf "$TMP_DIR"' EXIT

STDIN_DATA="$TMP_DIR/source.txt"
STRIPPED_SOURCE="$TMP_DIR/source.stripped"

# Capture input
if [[ -n "$INPUT_FILE" ]] && [[ -f "$INPUT_FILE" ]]; then
    cat "$INPUT_FILE" > "$STDIN_DATA"
else
    cat /dev/stdin > "$STDIN_DATA"
fi

# Create a version with NO whitespace/tabs/newlines for comparison
tr -d '[:space:]' < "$STDIN_DATA" > "$STRIPPED_SOURCE"

# 3. Iterate through Pandoc formats
GOOD_FMT=""

while read -r fmt; do
    # Skip output-only formats or problematic ones if necessary
    OUT_FILE="$TMP_DIR/out.$fmt"
    STRIPPED_OUT="$TMP_DIR/out.stripped.$fmt"

    # Attempt conversion to 'plain' to see if format 'fmt' is transparent
    if pandoc --wrap=none -f "$fmt" -t plain "$STDIN_DATA" -o "$OUT_FILE" 2>/dev/null; then
        # Strip whitespace from the output for comparison
        tr -d '[:space:]' < "$OUT_FILE" > "$STRIPPED_OUT"
        
        # Compare stripped versions
        if cmp -s "$STRIPPED_SOURCE" "$STRIPPED_OUT"; then
            GOOD_FMT="$fmt"
            echo "debug: Found transparent format: $GOOD_FMT" >&2
            break
        fi
    fi
done <<< "$(pandoc --list-input-formats)"

# 4. Final Conversion
if [[ -n "$GOOD_FMT" ]]; then
    pandoc --wrap=none -f "$GOOD_FMT" -t "$DEST_FORMAT" "$STDIN_DATA"
else
    echo "-----------------------------------------" >&2
    echo "[ERROR] Input contains markup characters for all known Pandoc formats.">&2
    echo "-----------------------------------------" >&2
    exit 1
fi
