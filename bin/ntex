#!/bin/bash

### If multiple input files are given, build each
if [[ -e "$2" ]]; then
    ITEMS_LIST=()
    PARAMS_LIST=()
    for i in $@; do
        if [[ -e "$1" ]]; then
            ITEMS_LIST+=("$1")
        else
            PARAMS_LIST+=("$1")
        fi
        shift
    done
    for i in ${ITEMS_LIST[@]}; do
        ntex $i ${PARAMS_LIST[@]}
    done
    exit 0
fi

XELATEXARGS=""

SYNC_HTTPTMP=y
#####################################################################
### Parse arguments. Magic; do not touch.
POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
  case $1 in
    --2)
        BUILD_TWICE="y"
        shift # past argument
        ;;
    --png)
        TOIMG="png"
        shift # past argument
        ;;
    --jpg)
        TOIMG="jpg"
        shift # past argument
        ;;
    --oss)
        TOCFOSS="y"
        shift # past argument
        ;;
    --range=*)
        PAGES_RANGE="${1/--range=/}"
        shift # past argument
        ;;
    --rname=*)
        RANGED_NAME="${1/--rname=/}"
        shift # past argument
        ;;
    --altfn=*)
        INPUT_ALTFN="${1/--altfn=/}.pdf"
        shift # past argument
        ;;
    --http)
        PUT_TO_HTTPTMP=y
        shift # past argument
        ;;
    --sync)
        SYNC_HTTPTMP=y
        shift # past argument
        ;;
    --nosync)
        SYNC_HTTPTMP=n
        shift # past argument
        ;;
    -*|--*)
        echo "Unknown option $1"
        exit 1
        ;;
    *)
        POSITIONAL_ARGS+=("$1") # save positional arg
        shift # past argument
        ;;
  esac
done
set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters
#####################################################################



FilePath="$1"
BaseName="$(basename "$FilePath")"
REPOID="$(basename "$PWD")"
TYPE_SLASH="${FilePath/$BaseName/}"

# echo "FilePath=$FilePath"
# echo "BaseName=$BaseName"
# echo "TYPE_SLASH=$TYPE_SLASH"

mkdir -p "_dist/tex-tmp" "_dist/$TYPE_SLASH"

function _realBuild() {
    xelatex $XELATEXARGS \
        -interaction=scrollmode \
        -output-directory=_dist/tex-tmp \
        -shell-escape \
        "$FilePath"
}
_realBuild
if [[ $BUILD_TWICE == y ]]; then ### Build twice
    _realBuild
fi

PDF_TMP_PATH="_dist/tex-tmp/${BaseName/.tex/.pdf}"
ls "$PDF_TMP_PATH"
if [[ ! -e "$PDF_TMP_PATH" ]]; then
    echo "[ERROR] XeLaTeX build failed. Aborting."
    exit 1
fi
mv "$PDF_TMP_PATH" "_dist/$TYPE_SLASH"

REALPATH=$(realpath "_dist/${FilePath/.tex/.pdf}")
PDFFN="$(basename "$REALPATH")"

echo -e "\nDocument Size:"
du -h "$REALPATH"

### --http
if [[ $PUT_TO_HTTPTMP == y ]]; then
    CLASSNAME="$(basename "$PWD")" ALTFN="$INPUT_ALTFN" cptmphttp "$REALPATH"
fi

### --oss
if [[ $TOCFOSS == y ]]; then
    ### New oss (Cloudflare R2):
    TMPFILE="/tmp/ntexcfosstmp-$(sha256sum <<< "$REALPATH" | cut -c1-30)"
    echo -e "\nOSS Document URLs:"
    OSS_SUBDIR="$(basename $PWD)" cfoss "$REALPATH" > $TMPFILE
    cat $TMPFILE
    OSSURL="$(grep FINAL_HTTP_URL $TMPFILE | cut -d= -f2-)"
    pushclip push neruthes <<< "$OSSURL"
    echo "$TYPE_SLASH$PDFFN $OSSURL" >> .osslist
    sort -u .osslist -o .osslist
    rm $TMPFILE
fi

### --jpg | --png
case "$TOIMG" in
    jpg|png)
        # mkdir -p /tmp/http/nteximg
        # chmod 777 /tmp/http/nteximg
        FHASH1="$(echo "$REALPATH" | sha256sum)"
        IMGPATH="$(basename "$REALPATH")-${FHASH1:0:12}.%d.$TOIMG"
        if [[ -e "$IMGPATH" ]]; then
            rm "$IMGPATH" 2>/dev/null
        fi
        # pdftoimg "$REALPATH" /tmp/http/nteximg $TOIMG
        pdftoimg "$REALPATH" '' $TOIMG
        if [[ $TOCFOSS == y ]]; then
            echo -e "\nImage URLs:"
            OSS_SUBDIR="$REPOID-img" cfoss "$IMGPATH"
        fi
        ;;
esac

### --range
if [[ ! -z "$PAGES_RANGE" ]]; then
    echo "Generating ranged subset."
    # RANGED_PDF_PATH="/tmp/${PDFFN/.pdf/}_page$PAGES_RANGE.pdf"
    # pdftk "$REALPATH" cat $PAGES_RANGE output "$RANGED_PDF_PATH"
    # du -h "$RANGED_PDF_PATH"
    # if [[ $TOCFOSS == y ]]; then
    #     OSS_SUBDIR=ntexdb-ranged cfoss "$RANGED_PDF_PATH"
    # fi
    RANGED_NAME="$RANGED_NAME" OSS=y pdfrange "$REALPATH" "$PAGES_RANGE"
fi


